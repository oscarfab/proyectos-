pipeline {
    agent any

    environment {
        APP_NAME = 'crud-app'
        IMAGE_TAG = "${BUILD_NUMBER}"
        DOCKER_IMAGE = "${APP_NAME}:${IMAGE_TAG}"
        GIT_REPO = 'https://github.com/oscarfab/proyectos-.git'
        GIT_BRANCH = 'main'
        PROJECT_PATH = 'CRUD con Conexion a BD_MYSQL'
        CONTAINER_NAME = 'crud-mysql-container'
        MYSQL_CONTAINER = 'mysql-jenkins'
        APP_PORT = '8080'
        HOST_PORT = '8081'
    }

    tools {
        maven 'Maven'
        jdk 'Java'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Descargando código desde GitHub...'
                checkout scmGit(
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[url: "${GIT_REPO}"]]
                )
            }
        }

        stage('Navigate to Project') {
            steps {
                echo 'Verificando directorio del proyecto...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat 'dir'
                        echo "Directorio actual: ${pwd()}"
                    }
                }
            }
        }

        stage('Clean') {
            steps {
                echo 'Limpiando proyecto...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat 'mvn clean'
                    }
                }
            }
        }

        stage('Compile') {
            steps {
                echo 'Compilando proyecto...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat 'mvn compile'
                    }
                }
            }
        }

        stage('Test') {
            steps {
                echo 'Ejecutando tests...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat 'mvn test'
                    }
                }
            }
        }

        stage('Package') {
            steps {
                echo 'Empaquetando aplicación...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat 'mvn package -DskipTests'
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Construyendo imagen Docker...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat "docker build -t ${DOCKER_IMAGE} ."
                        bat "docker tag ${DOCKER_IMAGE} ${APP_NAME}:latest"
                    }
                }
            }
        }

        stage('Stop Old Containers') {
            steps {
                echo 'Deteniendo contenedores anteriores...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat(script: "docker stop ${CONTAINER_NAME}", returnStatus: true)
                        bat(script: "docker rm ${CONTAINER_NAME}", returnStatus: true)
                        bat(script: "docker stop ${MYSQL_CONTAINER}", returnStatus: true)
                        bat(script: "docker rm ${MYSQL_CONTAINER}", returnStatus: true)
                    }
                }
            }
        }

        stage('Run MySQL Container') {
            steps {
                echo 'Iniciando contenedor MySQL...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat """
                            docker run -d ^
                            --name ${MYSQL_CONTAINER} ^
                            -e MYSQL_ROOT_PASSWORD=oscar ^
                            -e MYSQL_DATABASE=CRUD_DB ^
                            -p 3306:3306 ^
                            mysql:8
                        """
                    }
                }
            }
        }

        stage('Wait for MySQL') {
            steps {
                echo 'Esperando a que MySQL inicie...'
                sleep(15)
            }
        }

        stage('Run App Container') {
            steps {
                echo 'Iniciando contenedor de la aplicación...'
                script {
                    dir("${PROJECT_PATH}") {
                        bat """
                            docker run -d ^
                            --name ${CONTAINER_NAME} ^
                            -p ${HOST_PORT}:${APP_PORT} ^
                            -e SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/CRUD_DB ^
                            -e SPRING_DATASOURCE_USERNAME=root ^
                            -e SPRING_DATASOURCE_PASSWORD=oscar ^
                            ${APP_NAME}:latest
                        """
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                echo 'Verificando salud de la aplicación...'
                script {
                    dir("${PROJECT_PATH}") {
                        echo 'Esperando 30 segundos para que la aplicación inicie...'
                        sleep(30)

                        echo 'Logs de MySQL:'
                        bat "docker logs ${MYSQL_CONTAINER}"

                        echo ''
                        echo 'Logs de la aplicación:'
                        bat "docker logs ${CONTAINER_NAME}"

                        def containerRunning = bat(
                            script: "docker ps --filter name=${CONTAINER_NAME} --format \"{{.Names}}\"",
                            returnStdout: true
                        ).trim()

                        if (containerRunning.contains(CONTAINER_NAME)) {
                            echo 'Contenedor está corriendo'
                            echo "Aplicación disponible en: http://localhost:${HOST_PORT}/swagger-ui.html"
                        } else {
                            echo 'ERROR: El contenedor no está corriendo'
                            bat "docker logs ${CONTAINER_NAME}"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo '========================================='
            echo 'Build y despliegue completados!'
            echo '========================================='
            echo "Imagen: ${DOCKER_IMAGE}"
            echo "App Container: ${CONTAINER_NAME}"
            echo "MySQL Container: ${MYSQL_CONTAINER}"
            echo ""
            echo "URL Swagger: http://localhost:${HOST_PORT}/swagger-ui.html"
            echo ""
            echo "Comandos:"
            echo "  docker logs ${CONTAINER_NAME}"
            echo "  docker logs ${MYSQL_CONTAINER}"
            echo "  docker ps"
        }
        always {
            echo 'Limpiando workspace...'
            cleanWs()
        }
    }
}