pipeline {
    agent any

    environment {
        APP_NAME = 'crud-oracle-app'
        IMAGE_TAG = "${BUILD_NUMBER}"
        DOCKER_IMAGE = "${APP_NAME}:${IMAGE_TAG}"
        GIT_REPO = 'https://github.com/oscarfab/proyectos-.git'
        GIT_BRANCH = 'main'
        PROJECT_PATH = 'crud_con_Oracle'
        CONTAINER_NAME = 'crud-oracle-container'
        ORACLE_CONTAINER = 'oracle-jenkins'
        APP_PORT = '8088'
        HOST_PORT = '8088'
    }

    tools {
        maven 'Maven'
        jdk 'Java'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ Descargando cÃ³digo...'
                checkout scmGit(
                    branches: [[name: "*/${GIT_BRANCH}"]],
                    userRemoteConfigs: [[url: "${GIT_REPO}"]]
                )
            }
        }

        stage('Clean & Package') {
            steps {
                script {
                    dir("${PROJECT_PATH}") {
                        bat 'mvn clean package -DskipTests'
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir("${PROJECT_PATH}") {
                        bat "docker build -t ${DOCKER_IMAGE} ."
                        bat "docker tag ${DOCKER_IMAGE} ${APP_NAME}:latest"
                    }
                }
            }
        }

        stage('Stop Old Containers') {
            steps {
                script {
                    dir("${PROJECT_PATH}") {
                        bat(script: "docker stop ${CONTAINER_NAME}", returnStatus: true)
                        bat(script: "docker rm ${CONTAINER_NAME}", returnStatus: true)
                        bat(script: "docker stop ${ORACLE_CONTAINER}", returnStatus: true)
                        bat(script: "docker rm ${ORACLE_CONTAINER}", returnStatus: true)
                    }
                }
            }
        }

        stage('Run Oracle') {
            steps {
                script {
                    dir("${PROJECT_PATH}") {
                        bat """
                            docker run -d ^
                            --name ${ORACLE_CONTAINER} ^
                            -p 1521:1521 ^
                            -e ORACLE_PASSWORD=oracle ^
                            gvenzl/oracle-xe:21-slim
                        """
                    }
                }
            }
        }

        stage('Wait Oracle') {
            steps {
                sleep(90)
            }
        }

        stage('Run App') {
            steps {
                script {
                    dir("${PROJECT_PATH}") {
                        bat """
                            docker run -d ^
                            --name ${CONTAINER_NAME} ^
                            -p ${HOST_PORT}:${APP_PORT} ^
                            -e SPRING_DATASOURCE_URL=jdbc:oracle:thin:@host.docker.internal:1521/xepdb1 ^
                            -e SPRING_DATASOURCE_USERNAME=system ^
                            -e SPRING_DATASOURCE_PASSWORD=oracle ^
                            ${APP_NAME}:latest
                        """
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    sleep(30)
                    bat "docker logs ${CONTAINER_NAME}"
                    echo "âœ… App: http://localhost:${HOST_PORT}/swagger-ui.html"
                }
            }
        }
    }

    post {
        success {
            echo "âœ… SUCCESS - http://localhost:${HOST_PORT}/swagger-ui.html"
        }
        always {
            cleanWs()
        }
    }
}